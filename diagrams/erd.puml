@startuml Bookty E-Commerce Entity Relationship Diagram

!define RECTANGLE class
skinparam linetype ortho
skinparam defaultFontSize 10
skinparam roundcorner 5

title Bookty E-Commerce System - Entity Relationship Diagram

' ========== CORE ENTITIES ==========

entity "users" as users {
  * id : bigint <<PK>>
  --
  name : varchar
  email : varchar <<unique>>
  email_verified_at : timestamp
  password : varchar
  remember_token : varchar
  phone : varchar
  address : text
  city : varchar
  state : varchar
  postal_code : varchar
  created_at : timestamp
  updated_at : timestamp
}

entity "genres" as genres {
  * id : bigint <<PK>>
  --
  name : varchar
  slug : varchar <<unique>>
  description : text
  created_at : timestamp
  updated_at : timestamp
}

entity "tropes" as tropes {
  * id : bigint <<PK>>
  --
  name : varchar
  slug : varchar <<unique>>
  description : text
  created_at : timestamp
  updated_at : timestamp
}

entity "books" as books {
  * id : bigint <<PK>>
  --
  * genre_id : bigint <<FK>>
  title : varchar
  slug : varchar <<unique>>
  author : varchar
  synopsis : text
  price : decimal(8,2)
  stock : integer
  cover_image : varchar
  cost_price : decimal
  condition : varchar
  created_at : timestamp
  updated_at : timestamp
}

entity "book_trope" as book_trope {
  * id : bigint <<PK>>
  --
  * book_id : bigint <<FK>>
  * trope_id : bigint <<FK>>
  created_at : timestamp
  updated_at : timestamp
}

' ========== COMMERCE ENTITIES ==========

entity "orders" as orders {
  * id : bigint <<PK>>
  --
  * user_id : bigint <<FK>>
  coupon_id : bigint <<FK>> <<nullable>>
  postage_rate_history_id : bigint <<FK>> <<nullable>>
  public_id : varchar <<unique>>
  total_amount : decimal(10,2)
  status : varchar
  payment_status : varchar
  shipping_address : varchar
  shipping_city : varchar
  shipping_state : varchar
  shipping_postal_code : varchar
  shipping_phone : varchar
  shipping_region : enum
  shipping_customer_price : decimal
  shipping_actual_cost : decimal
  discount_amount : decimal
  coupon_code : varchar
  admin_notes : text
  tracking_number : varchar
  toyyibpay_billcode : varchar
  toyyibpay_status : varchar
  created_at : timestamp
  updated_at : timestamp
}

entity "order_items" as order_items {
  * id : bigint <<PK>>
  --
  * order_id : bigint <<FK>>
  * book_id : bigint <<FK>>
  quantity : integer
  price : decimal(8,2)
  cost_price : decimal
  created_at : timestamp
  updated_at : timestamp
}

entity "carts" as carts {
  * id : bigint <<PK>>
  --
  * user_id : bigint <<FK>>
  created_at : timestamp
  updated_at : timestamp
}

entity "cart_items" as cart_items {
  * id : bigint <<PK>>
  --
  * cart_id : bigint <<FK>>
  * book_id : bigint <<FK>>
  quantity : integer
  created_at : timestamp
  updated_at : timestamp
}

' ========== PROMOTION ENTITIES ==========

entity "coupons" as coupons {
  * id : bigint <<PK>>
  --
  code : varchar <<unique>>
  description : varchar
  discount_type : enum
  discount_value : decimal(10,2)
  min_purchase_amount : decimal
  max_uses_per_user : integer
  max_uses_total : integer
  starts_at : timestamp
  expires_at : timestamp
  is_active : boolean
  free_shipping : boolean
  created_at : timestamp
  updated_at : timestamp
}

entity "coupon_usages" as coupon_usages {
  * id : bigint <<PK>>
  --
  * coupon_id : bigint <<FK>>
  * user_id : bigint <<FK>>
  * order_id : bigint <<FK>>
  discount_amount : decimal(10,2)
  created_at : timestamp
  updated_at : timestamp
}

entity "flash_sales" as flash_sales {
  * id : bigint <<PK>>
  --
  name : varchar
  description : text
  starts_at : timestamp
  ends_at : timestamp
  discount_type : enum
  discount_value : decimal(10,2)
  is_active : boolean
  created_at : timestamp
  updated_at : timestamp
}

entity "flash_sale_items" as flash_sale_items {
  * id : bigint <<PK>>
  --
  * flash_sale_id : bigint <<FK>>
  * book_id : bigint <<FK>>
  special_price : decimal
  created_at : timestamp
  updated_at : timestamp
}

entity "book_discounts" as book_discounts {
  * id : bigint <<PK>>
  --
  * book_id : bigint <<FK>>
  discount_amount : decimal
  discount_percent : decimal
  starts_at : timestamp
  ends_at : timestamp
  is_active : boolean
  description : varchar
  created_at : timestamp
  updated_at : timestamp
}

' ========== ENGAGEMENT ENTITIES ==========

entity "reviews" as reviews {
  * id : bigint <<PK>>
  --
  * user_id : bigint <<FK>>
  * book_id : bigint <<FK>>
  * order_item_id : bigint <<FK>>
  rating : integer
  comment : text
  is_approved : boolean
  images : json
  created_at : timestamp
  updated_at : timestamp
}

entity "review_helpfuls" as review_helpfuls {
  * id : bigint <<PK>>
  --
  * review_id : bigint <<FK>>
  * user_id : bigint <<FK>>
  created_at : timestamp
  updated_at : timestamp
}

entity "review_reports" as review_reports {
  * id : bigint <<PK>>
  --
  * review_id : bigint <<FK>>
  * user_id : bigint <<FK>>
  admin_id : bigint <<FK>> <<nullable>>
  reason : enum
  description : text
  status : enum
  admin_notes : text
  reviewed_at : timestamp
  created_at : timestamp
  updated_at : timestamp
}

entity "wishlists" as wishlists {
  * id : bigint <<PK>>
  --
  * user_id : bigint <<FK>>
  * book_id : bigint <<FK>>
  created_at : timestamp
  updated_at : timestamp
}

entity "user_book_interactions" as user_book_interactions {
  * id : bigint <<PK>>
  --
  * user_id : bigint <<FK>>
  * book_id : bigint <<FK>>
  action : varchar(20)
  weight : decimal(3,1)
  count : integer
  last_interacted_at : timestamp
  created_at : timestamp
  updated_at : timestamp
}

' ========== SHIPPING ENTITIES ==========

entity "postage_rates" as postage_rates {
  * id : bigint <<PK>>
  --
  region : enum
  customer_price : decimal(10,2)
  actual_cost : decimal(10,2)
  created_at : timestamp
  updated_at : timestamp
}

entity "postage_rate_history" as postage_rate_history {
  * id : bigint <<PK>>
  --
  * postage_rate_id : bigint <<FK>>
  updated_by : bigint <<FK>> <<nullable>>
  customer_price : decimal(10,2)
  actual_cost : decimal(10,2)
  comment : text
  valid_from : timestamp
  valid_until : timestamp
  created_at : timestamp
}

' ========== CONFIGURATION ==========

entity "settings" as settings {
  * id : bigint <<PK>>
  --
  key : varchar <<unique>>
  value : text
  group : varchar
  created_at : timestamp
  updated_at : timestamp
}

' ========== RELATIONSHIPS ==========

' Users
users ||--o{ orders : "places"
users ||--o| carts : "has"
users ||--o{ reviews : "writes"
users ||--o{ wishlists : "has"
users ||--o{ coupon_usages : "uses"
users ||--o{ user_book_interactions : "tracks"
users ||--o{ review_helpfuls : "marks"
users ||--o{ review_reports : "reports"
users ||--o{ postage_rate_history : "updates"

' Genres & Tropes
genres ||--o{ books : "categorises"
books ||--o{ book_trope : "has"
tropes ||--o{ book_trope : "has"

' Orders
orders ||--o{ order_items : "contains"
orders }o--o| coupons : "applies"
orders }o--o| postage_rate_history : "uses"
order_items }o--|| books : "references"
order_items ||--o{ reviews : "reviewed in"

' Carts
carts ||--o{ cart_items : "contains"
cart_items }o--|| books : "references"

' Coupons
coupons ||--o{ coupon_usages : "tracked by"
coupon_usages }o--|| users : "used by"
coupon_usages }o--|| orders : "applied to"

' Flash Sales
flash_sales ||--o{ flash_sale_items : "includes"
flash_sale_items }o--|| books : "references"

' Book Discounts
book_discounts }o--|| books : "applies to"

' Reviews
reviews }o--|| books : "for"
reviews }o--|| order_items : "on"
reviews ||--o{ review_helpfuls : "has"
reviews ||--o{ review_reports : "has"
review_reports }o--o| users : "reviewed by admin"

' Wishlists
wishlists }o--|| users : "belongs to"
wishlists }o--|| books : "contains"

' User Book Interactions
user_book_interactions }o--|| users : "by"
user_book_interactions }o--|| books : "for"

' Postage
postage_rates ||--o{ postage_rate_history : "history"
postage_rate_history }o--o| users : "updated by"

@enduml
